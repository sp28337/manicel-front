name: CI/CD Deployment

on:
  push:
    branches: ["local"]
  pull_request:
    branches: ["local"]

env:
  NODE_VERSION: "22.16.0"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Lint
      run: npm run lint

    - name: Cache Next.js
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          .next/cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: manicel
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p ${{ secrets.PORT }} 109.73.207.195 >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Deploy to server via SSH
      run: |
        ssh -o StrictHostKeyChecking=no -p ${{ secrets.PORT }} sp28337@109.73.207.195 << 'DEPLOY_SCRIPT'
        set -e
        
        echo "ðŸš€ Starting deployment..."
        
        # ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð² ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
        cd ~/manicel/frontend
        
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ NVM
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Node
        nvm use 22.16.0 || nvm install 22.16.0
        echo "âœ… Node $(node --version), NPM $(npm --version)"
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
        git fetch origin
        git switch local || git checkout local
        git pull origin local
        
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
        echo "ðŸ“¦ Building..."
        npm install
        npm run build
        
        # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ PM2 (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ npx Ð²Ð¼ÐµÑÑ‚Ð¾ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸)
        echo "ðŸ”„ Reloading PM2..."
        cd ~/manicel
        npx pm2 reload ecosystem.config.js --update-env || npx pm2 start ecosystem.config.js
        npx pm2 save
        
        echo "âœ… Deployment completed!"
        DEPLOY_SCRIPT

    - name: Verify deployment
      if: always()
      run: |
        ssh -o StrictHostKeyChecking=no -p ${{ secrets.PORT }} sp28337@109.73.207.195 << 'VERIFY_SCRIPT'
        echo "ðŸ” PM2 Status:"
        npx pm2 status
        echo ""
        echo "ðŸ“‹ Listening ports:"
        ss -tulpn 2>/dev/null | grep LISTEN || netstat -tulpn | grep LISTEN || true
        VERIFY_SCRIPT